---
layout: post
title: CoreText的简单使用（三）
subtitle: CoreText的简单使用
date: 2020-08-10
author: KG丿夏沫
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
  - iOS
  - 图文混排
  - CoreText
  - 面试题
---

# CoreText的简单使用（三）

### 前言：

>基于前面文章<a href="https://kgdeveloper.github.io/2020/08/10/CoreText%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E4%BA%8C/">《CoreText的简单使用（二）》</a>的介绍，我们基于CoreText封装了一个简单的文本排版框架，但是它有很大的局限性，因为我们平时开发的时候，如果需要文本排版，很大可能性就是需要一段文本中展示不同样式，可能有多种字体、颜色、大小等。所以基于之前的框架基础上再次进行修改。

### 定制排版文件格式

>我们首先想到对```KGCTFrameParser```进行修改，因为我们使用UILabel加载富文本的时候，就是使用NSAttributeString来实现文本变色、字体大小变化等。所以我们修改KGCTFrameParser类的方法，使用NSAttributeString作为参数。

>修改后```KGCTFrameParser```类代码如下:

```
#import <Foundation/Foundation.h>
#import "KGCoreTextData.h"
#import "KGCTFrameParserConfig.h"


NS_ASSUME_NONNULL_BEGIN

@interface KGCTFrameParser : NSObject

+ (KGCoreTextData *)parseContent:(NSAttributedString *)content config:(KGCTFrameParserConfig *)config;

+ (NSDictionary *)attributesWithConfig:(KGCTFrameParserConfig *)config;

@end

NS_ASSUME_NONNULL_END

#import "KGCTFrameParser.h"

@implementation KGCTFrameParser

+ (NSDictionary *)attributesWithConfig:(KGCTFrameParserConfig *)config{
    CGFloat fontSize = config.fontSize;
    CTFontRef fontRef = CTFontCreateWithName((CFStringRef)@"ArialMT", fontSize, NULL);
    CGFloat lineSpacing = config.lineSpace;
    const CFIndex kNumberOfSettings = 3;
    CTParagraphStyleSetting theSettings[kNumberOfSettings] = {
        {kCTParagraphStyleSpecifierLineSpacingAdjustment,sizeof(CGFloat),&lineSpacing},
        {kCTParagraphStyleSpecifierMaximumLineSpacing,sizeof(CGFloat),&lineSpacing},
        {kCTParagraphStyleSpecifierMinimumLineSpacing,sizeof(CGFloat),&lineSpacing}
    };
    CTParagraphStyleRef theParagraphRef = CTParagraphStyleCreate(theSettings, kNumberOfSettings);
    
    UIColor *textColor = config.textColor;
    
    NSMutableDictionary *dict = [NSMutableDictionary dictionary];
    dict[NSForegroundColorAttributeName] = (id)textColor.CGColor;
    dict[NSFontAttributeName] = (__bridge id)fontRef;
    dict[NSParagraphStyleAttributeName] = (__bridge id)theParagraphRef;
    
    CFRelease(theParagraphRef);
    CFRelease(fontRef);
    return dict;
}

+ (KGCoreTextData *)parseContent:(NSAttributedString *)content config:(KGCTFrameParserConfig *)config{
    //创建CTFramesetterRef实例
    CTFramesetterRef frameSetter = CTFramesetterCreateWithAttributedString((CFAttributedStringRef)content);
    //获得要绘制的区域的高度
    CGSize restrictSize = CGSizeMake(config.width, CGFLOAT_MAX);
    CGSize coreTextSize = CTFramesetterSuggestFrameSizeWithConstraints(frameSetter, CFRangeMake(0, 0), nil, restrictSize, nil);
    CGFloat textHeight = coreTextSize.height;
    
    //生成CTFrameRef实例
    CTFrameRef frame = [self createFrameWithFrameSetter:frameSetter config:config height:textHeight];
    
    //将生成好的CTFrameRef实例和计算好的绘制高度保存到CoreTextData实例中，最后返回实例
    KGCoreTextData *data = [[KGCoreTextData alloc] init];
    data.ctFrame = frame;
    data.height = textHeight;
    CFRelease(frame);
    CFRelease(frameSetter);
    return data;
}

+ (CTFrameRef)createFrameWithFrameSetter:(CTFramesetterRef)frameSetter config:(KGCTFrameParserConfig *)config height:(CGFloat)height{
    CGMutablePathRef path = CGPathCreateMutable();
    CGPathAddRect(path, NULL, CGRectMake(0, 0, config.width, height));
    CTFrameRef frame = CTFramesetterCreateFrame(frameSetter, CFRangeMake(0, 0), path, NULL);
    CFRelease(path);
    return frame;
}

@end
```

>然后在KGCoreTextCtrl中进行配置，代码如下：

```
- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.view.backgroundColor = [UIColor whiteColor];
    
    KGCTFrameParserConfig *config = [[KGCTFrameParserConfig alloc] init];
    config.textColor = [UIColor blackColor];
    config.width = self.ctView.width;
    
    NSString *str = @"这是一个测试代码，主要是为了展示富文本，前面一句话显示红色，第二句话显示绿色，三句话字体放大";
    NSDictionary *attr = [KGCTFrameParser attributesWithConfig:config];
    
    NSMutableAttributedString *attributeString = [[NSMutableAttributedString alloc] initWithString:str attributes:attr];

    [attributeString addAttributes:@{NSForegroundColorAttributeName:[UIColor redColor]} range:NSMakeRange(0, 9)];
    [attributeString addAttributes:@{NSForegroundColorAttributeName:[UIColor greenColor]} range:NSMakeRange(10, 10)];
    [attributeString addAttributes:@{NSForegroundColorAttributeName:[UIColor blueColor],NSFontAttributeName:KGFont(20.0)} range:NSMakeRange(21, 10)];
    
    KGCoreTextData *data = [KGCTFrameParser parseContent:attributeString config:config];
    
    self.ctView.data = data;
    self.ctView.height = data.height;
    self.ctView.backgroundColor = [UIColor yellowColor];
}

- (KGDisPlayView *)ctView{
    if (!_ctView) {
        self.ctView = [[KGDisPlayView alloc] initWithFrame:CGRectMake(50, 100, self.view.frame.size.width - 100, 300)];
        [self.view addSubview:self.ctView];
    }
    return _ctView;
}
```

>最后运行项目，查看效果，如下图所示：

<img src="/img/20200810003.png" alert="富文本排版">

>到此我们的框架可以支持富文本格式的文本渲染了，下一篇，开始探索图文混排。

### 系列文章:

><a href="https://kgdeveloper.github.io/2020/08/10/CoreText%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E4%B8%80/">《CoreText的简单使用（一）》</a>

><a href="https://kgdeveloper.github.io/2020/08/10/CoreText%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E4%BA%8C/">《CoreText的简单使用（二）》</a>

><a href="https://kgdeveloper.github.io/2020/08/10/CoreText%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E4%B8%89/">《CoreText的简单使用（三）》</a>

><a href="https://kgdeveloper.github.io/2020/08/10/CoreText%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E5%9B%9B/">《CoreText的简单使用（四）》</a>

><a href="https://kgdeveloper.github.io/2020/08/10/CoreText%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-%E4%BA%94/">《CoreText的简单使用（五）》</a>